# æ¨¡å—æ·±åŒ–ï¼šç”¨æˆ·çŠ¶æ€ä¸ä¸ªæ€§åŒ– (Module 5: User State & Personalization)

## 1. æ¦‚è§ˆ
æœ¬é˜¶æ®µé‡ç‚¹å®ç°äº† Agent çš„ **ç”¨æˆ·èº«ä»½ç®¡ç†** å’Œ **é•¿æœŸè®°å¿†/ä¸ªæ€§åŒ–** åŠŸèƒ½ã€‚
ç°åœ¨ï¼ŒAgent ä¸å†æ˜¯ä¸€ä¸ªæ— çŠ¶æ€çš„å·¥å…·ï¼Œè€Œæ˜¯ä¸€ä¸ªèƒ½è®°ä½ç”¨æˆ·çš„åå­—ã€å†å²å¯¹è¯å’Œè®¿é—®ä¹ æƒ¯çš„ä¸ªæ€§åŒ–åŠ©æ‰‹ã€‚

## 2. æ ¸å¿ƒåŠŸèƒ½å®ç°

### 2.1 ç”¨æˆ·è®¤è¯ç³»ç»Ÿ (Frontend Auth)
- **`useAuth` Composable**: 
  - å°è£…äº†ç™»å½•ã€æ³¨å†Œã€æ³¨é”€å’Œä¼šè¯åˆå§‹åŒ–çš„æ ¸å¿ƒé€»è¾‘ã€‚
  - ä½¿ç”¨ `localStorage` æŒä¹…åŒ– `userId` å’Œ tokenã€‚
  - æä¾›äº† `currentUser` å’Œ `isAuthenticated` å“åº”å¼çŠ¶æ€ä¾›å…¨å±€ä½¿ç”¨ã€‚

- **`AuthForm` ç»„ä»¶**:
  - åˆ›å»ºäº†å…¨æ–°çš„ç™»å½•/æ³¨å†Œè¡¨å•ç»„ä»¶ã€‚
  - æ”¯æŒæ¨¡å¼åˆ‡æ¢ï¼ˆLogin <-> Registerï¼‰ã€‚
  - é›†æˆäº†åŠ è½½çŠ¶æ€å’Œé”™è¯¯å¤„ç†ã€‚

### 2.2 èŠå¤©çª—å£çš„èº«ä»½é›†æˆ (ChatWindow Integration)
- **å¤šè§†å›¾æ¶æ„**: 
  - `ChatWindow` ç°åœ¨æ”¯æŒ `chat` å’Œ `auth` ä¸¤ç§è§†å›¾æ¨¡å¼ã€‚
  - å¤´éƒ¨å¢åŠ äº†ç”¨æˆ·å›¾æ ‡ (ğŸ‘¤/ğŸ”‘)ï¼Œç‚¹å‡»å³å¯åœ¨èŠå¤©å’Œä¸ªäººèµ„æ–™/ç™»å½•é¡µä¹‹é—´åˆ‡æ¢ã€‚
- **ä¸ªäººèµ„æ–™é¡µ**:
  - ç™»å½•åæ˜¾ç¤ºç”¨æˆ·å¤´åƒã€åç§°ã€ID å’Œè®¿é—®æ¬¡æ•°ç»Ÿè®¡ã€‚
  - æä¾›æ³¨é”€ (Logout) æŒ‰é’®ã€‚

### 2.3 é•¿æœŸè®°å¿†ä¸å†å²å›æº¯ (Long-term Memory)
- **åç«¯å¢å¼º**:
  - æ–°å¢ `GET /api/chat/history/:userId` æ¥å£ï¼Œå…è®¸å‰ç«¯æ‹‰å–å†å²å¯¹è¯è®°å½•ã€‚
  - é™åˆ¶è¿”å›æœ€è¿‘ 20 æ¡æ¶ˆæ¯ï¼Œä¿è¯æ€§èƒ½ã€‚
- **å‰ç«¯é›†æˆ**:
  - å½“ç”¨æˆ·ç™»å½•æˆåŠŸæ—¶ï¼ŒAgent ä¼šè‡ªåŠ¨ä»åç«¯æ‹‰å–å†å²è®°å½•å¹¶å¡«å……åˆ°èŠå¤©çª—å£ã€‚
  - æ¶ˆæ¯æ ¼å¼è‡ªåŠ¨æ˜ å°„ (`model` -> `agent`)ã€‚
  - æ·»åŠ äº†ä¸€æ¡ç‰¹æ®Šçš„ "Restored history" ç³»ç»Ÿæ¶ˆæ¯ï¼Œæç¤ºç”¨æˆ·ä¸Šä¸‹æ–‡å·²æ¢å¤ã€‚

### 2.4 ä¸ªæ€§åŒ–é—®å€™ (Personalization)
- **æ™ºèƒ½é—®å€™**:
  - `Agent.vue` ç›‘å¬ç”¨æˆ·ç™»å½•çŠ¶æ€ã€‚
  - **æ–°ç”¨æˆ·**: æ˜¾ç¤º "Nice to meet you!"ã€‚
  - **è€ç”¨æˆ· (Visits > 1)**: æ˜¾ç¤º "Welcome back, [Name]!" å¹¶è§¦å‘å¼€å¿ƒ (Happy) åŠ¨ç”»ã€‚
  - **æ³¨é”€**: æ˜¾ç¤º "See you later!"ã€‚

## 3. æ–‡ä»¶å˜æ›´
- **Created**:
  - `frontend/src/agent/composables/useAuth.ts`
  - `frontend/src/agent/components/AuthForm.vue`
- **Modified**:
  - `frontend/src/agent/components/Agent.vue` (Auth integration, Watchers)
  - `frontend/src/agent/components/ChatWindow.vue` (Auth UI, View switching)
  - `frontend/src/agent/services/aiService.ts` (History API)
  - `backend/server.js` (History Endpoint)

## 4. ä¸‹ä¸€æ­¥è®¡åˆ’ (Refinement)
- **UI ç¾åŒ–**: ç›®å‰çš„ Auth è¡¨å•æ ·å¼è¾ƒä¸ºåŸºç¡€ï¼Œå¯ä»¥è¿›ä¸€æ­¥ç»“åˆ Q ç‰ˆé£æ ¼è¿›è¡Œç¾åŒ–ã€‚
- **è¯­éŸ³é—®å€™**: ç»“åˆ TTSï¼Œè®© Agent åœ¨æ¬¢è¿å›æ¥æ—¶ç›´æ¥è¯´å‡ºç”¨æˆ·çš„åå­—ã€‚
- **åå¥½è®¾ç½®**: åœ¨ä¸ªäººèµ„æ–™é¡µæ·»åŠ  "Agent è¡Œä¸ºè®¾ç½®" (å¦‚æ˜¯å¦å¼€å¯éŸ³æ•ˆã€æ˜¯å¦å¼€å¯çœ©æ™•æ¨¡å¼ç­‰)ã€‚
